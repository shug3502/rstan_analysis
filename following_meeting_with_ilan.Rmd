---
title: "Following meeting with Ilan"
author: "Jonathan Harrison"
date: "9 October 2018"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=4,
                      echo=FALSE, warning=FALSE, message=FALSE)
```

##Notes following meeting with Ilan on 8th October.

Include observed data in Figure 7 or similar figure. Show unnormalised. 
Also quantify in WT and OE the number and fraction of transcripts that are localized. 
Demonstrate that particles are equivalent between WT and the OE mutant. 

To investigate:
Inhomogeneous production due to patchy expression of the gal-4 driver. 
Inhomogeneous transport through ring canals. 
Waiting of mRNA to form into complexes at the nuclear pore complex, such as for assembly with dynein or other proteins. 
(Model comparison between some of these are the 'normal' model).

#Observed data

##Observed distribution of RNA across cells
To illustrate these ideas, we plot the RNA distributions for WT and OE based on observed data.
```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
source('extract_times_and_scaling.R')
times = extract_times_and_scaling(9,11,9)
my_normaliser <- function(dataset) apply(dataset,1,function(x)x/x[1]) %>% t()
  data = matrix(as.numeric(read.csv('data/exp_data.csv',sep=',',header=FALSE,stringsAsFactors = FALSE)),ncol=16,byrow=TRUE)
  raw_data = data[times$sort_indices1,] #need to sort time series and correspondingly reorder rows
  exp_data = raw_data
  exp_data[is.na(exp_data)]=0 #stan can't deal with NAs
  overexpression_data = matrix(as.numeric(read.csv('data/exp_data_overexpression.csv',sep=',',header=FALSE,stringsAsFactors = FALSE)),ncol=16,byrow=TRUE)
  overexpression_data = overexpression_data[times$sort_indices4,] #need to sort time series and correspondingly reorder rows
  test_data = rbind(data,overexpression_data)
  test_data = test_data[times$sort_indices2,]
  test_data[is.na(test_data)]=0
 
  normalised_data = exp_data %>% my_normaliser #divide by amount in oocyte to normalise for stst
colnames(normalised_data) = seq_len(16)
df_wt <- as.data.frame(normalised_data) %>% mutate(time=times$ts1) %>% gather(key=cell,value=rna,-time) %>% mutate(phenotype='WT',cell=as.integer(cell))


normalised_data = overexpression_data %>% my_normaliser #divide by amount in oocyte to normalise
colnames(normalised_data) = seq_len(16)
df_oe <- as.data.frame(normalised_data) %>% mutate(time=times$ts4) %>% gather(key=cell,value=rna,-time) %>% mutate(phenotype='OE',cell=as.integer(cell))  
g1 <- full_join(df_wt,df_oe) %>%
  ggplot(aes(x=cell,y=rna,group=time,color=factor(time))) +
  geom_line() +
  facet_grid(~phenotype) +
  theme_bw() +
  theme(legend.position='None')
print(g1)
ggsave('plots/normalised_data_distn.eps',device=cairo_ps)

g2 <- df_oe %>% 
  ggplot(aes(x=cell,y=rna)) +
  geom_line() +
  facet_wrap(~time) +
  theme_bw() +
  theme(legend.position='None')
print(g2)
ggsave('plots/normalised_data_distn_faceted.eps',device=cairo_ps)

```

The same thing but without the normalisation:

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
source('extract_times_and_scaling.R')
times = extract_times_and_scaling(9,11,9)
data = matrix(as.numeric(read.csv('data/exp_data.csv',sep=',',header=FALSE,stringsAsFactors = FALSE)),ncol=16,byrow=TRUE)
exp_data = data[times$sort_indices1,] #need to sort time series and correspondingly reorder rows
exp_data[is.na(exp_data)]=0 #stan can't deal with NAs
overexpression_data = matrix(as.numeric(read.csv('data/exp_data_overexpression.csv',sep=',',header=FALSE,stringsAsFactors = FALSE)),ncol=16,byrow=TRUE)
overexpression_data = overexpression_data[times$sort_indices4,] #need to sort time series and correspondingly reorder rows
colnames(exp_data) = seq_len(16)
df_wt <- as.data.frame(exp_data) %>% mutate(time=times$ts1) %>% gather(key=cell,value=rna,-time) %>% mutate(phenotype='WT',cell=as.integer(cell))


colnames(overexpression_data) = seq_len(16)
df_oe <- as.data.frame(overexpression_data) %>% mutate(time=times$ts4) %>% gather(key=cell,value=rna,-time) %>% mutate(phenotype='OE',cell=as.integer(cell))  

h1 <- full_join(df_wt,df_oe) %>%
  ggplot(aes(x=cell,y=rna,group=time,color=factor(time))) +
  geom_line() +
  facet_grid(~phenotype) +
  theme_bw() +
  theme(legend.position='None')
print(h1)
ggsave('plots/unnormalised_data_distn.eps',device=cairo_ps)

h2 <- full_join(df_wt,df_oe) %>% 
  ggplot(aes(x=cell,y=rna,color=factor(phenotype))) +
  geom_line() +
  facet_wrap(~time) +
  theme_bw() +
  theme(legend.position='None')
print(h2)
ggsave('plots/unnormalised_data_distn_faceted.eps',device=cairo_ps)
```


##Show the number and fraction of complexes localized

```{r}
gurken_rna_df <- full_join(df_wt,df_oe)
quantify_for_ilan <- gurken_rna_df %>% 
  group_by(time) %>%
  mutate(phenotype = factor(phenotype),
         number = rna[cell==1],
         fraction = number/sum(rna),
         total = sum(rna)) %>%
  filter(cell==1)


g1 <- ggplot(data = quantify_for_ilan, aes(x=phenotype,y=number)) + 
  geom_violin(draw_quantiles = c(0.5)) +
  geom_jitter() + 
  theme_bw()
print(g1)

g2 <- ggplot(data = quantify_for_ilan, aes(x=phenotype,y=fraction)) + 
  geom_violin(draw_quantiles = c(0.5)) +
  geom_jitter() + 
  theme_bw()
print(g2)

g3 <- ggplot(data = quantify_for_ilan, aes(x=phenotype,y=total)) + 
  geom_violin(draw_quantiles = c(0.5)) +
  geom_jitter() + 
  theme_bw()
print(g3)

library(patchwork)
g1 + g2 + g3

h1 <- ggplot(data = quantify_for_ilan, aes(x=time,y=number,color=phenotype)) + 
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  theme_bw()
print(h1)

h2 <- ggplot(data = quantify_for_ilan, aes(x=time,y=fraction,color=phenotype)) + 
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  theme_bw()
print(h2)

h3 <- ggplot(data = quantify_for_ilan, aes(x=time,y=total,color=phenotype)) + 
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  theme_bw()
print(h3)
h1+h2+h3

```

These plots of the observed data suggest that the fraction of complexes localized is different between wild type and overexpressor. The number of transcripts localized also appeasrs lower in the overexpression mutant, but in my opinion this is due to the age/size of the egg chambers considered. The egg chambers quantified are generally smaller. (Possible bias here as there are too many particles in the larger overexpression datasets so that MATLAB runs out of memory in running the FISH-quant code to localize the transcripts.)


##How many times greater is production in the overexpressor than in wild type?
We fit a linear model to the data on total RNA counts in each egg chamber for each phenotype. 
If $$z = \sum_{i=1}^{16} y_i$$ is the total RNA count in each egg chamber, then $$\frac{\text{d} z}{\text{d} t} = 15a.$$ Therefore $$ z = z_0 + 15at.$$

Based on the total RNA counts in each egg chamber, we can estimate production rate $a$ directly for WT and OE data and give a ratio of how much bigger the production for the OE is.

```{r}
growth_WT <- lm(data=quantify_for_ilan %>% filter(phenotype=='WT'), total ~ time) 
growth_OE <- lm(data=quantify_for_ilan %>% filter(phenotype=='OE'), total ~ time) 
print(coef(growth_WT)[['time']]/15)
print(coef(growth_OE)[['time']]/15)
print(coef(growth_OE)[['time']]/coef(growth_WT)[['time']])
```
This neglects effects from assembly in the oocyte, which we ought to account for. 

```{r}
quantify_with_assembly <- gurken_rna_df %>% 
  mutate(phenotype = factor(phenotype)) %>%
  group_by(time) %>%
  mutate(phi = case_when(phenotype=='WT' ~ 0.345,
                         phenotype=='OE' ~ 0.300,
                         TRUE ~ NaN),
         total = sum(rna[cell!=1]) + rna[cell==1]/phi[cell==1]) %>%
  filter(cell==1)
growth_WT <- lm(data=quantify_with_assembly %>% filter(phenotype=='WT'), total ~ time) 
growth_OE <- lm(data=quantify_with_assembly %>% filter(phenotype=='OE'), total ~ time) 
print(coef(growth_WT)[['time']]/15)
print(coef(growth_OE)[['time']]/15)
print(coef(growth_OE)[['time']]/coef(growth_WT)[['time']])
```

Based on this it seems reasonable to keep using $2a$ as the production in the overexpressor.

```{r}
source('mrna_transport_full.R')
identifier <- 'v431WT_simple'
res_simple = mrna_transport_inference_full(identifier = identifier,
						use_real_data = TRUE, run_mcmc = FALSE,
						nSamples = 9, nTest = 11, nTestOE = 9,
						verbose = FALSE, compare_via_loo = TRUE,
						show_diagnostic_plots = FALSE, use_hierarchical_model = FALSE,
						use_prior_predictive = FALSE, train_on_OE = FALSE,
						use_binary_producers = FALSE,
						parametersToPlot = c('a','b','nu','phi','sigma'),
						is_nu_uniform = TRUE, no_decay_model = TRUE)
identifier <- 'v432_with_blocking'
res_block = mrna_transport_inference_full(identifier = identifier,
						use_real_data = TRUE, run_mcmc = FALSE,
						nSamples = 9, nTest = 11, nTestOE = 9,
						verbose = FALSE, compare_via_loo = TRUE,
						show_diagnostic_plots = FALSE, use_hierarchical_model = FALSE,
						use_prior_predictive = FALSE, train_on_OE = FALSE,
						use_binary_producers = FALSE, use_blocked_RCs = TRUE,
						parametersToPlot = c('a','b','nu','phi','sigma'),
						is_nu_uniform = TRUE, no_decay_model = TRUE)
identifier <- 'v433_with_production'
res_prod = mrna_transport_inference_full(identifier = identifier,
						use_real_data = TRUE, run_mcmc = FALSE,
						nSamples = 9, nTest = 11, nTestOE = 9,
						verbose = FALSE, compare_via_loo = TRUE,
						show_diagnostic_plots = FALSE, use_hierarchical_model = FALSE,
						use_prior_predictive = FALSE, train_on_OE = FALSE,
						use_binary_producers = TRUE,
						parametersToPlot = c('a','b','nu','phi','sigma'),
						is_nu_uniform = TRUE, no_decay_model = TRUE)
identifier <- 'v434_with_production4a'
res_prod4a = mrna_transport_inference_full(identifier = identifier,
						use_real_data = TRUE, run_mcmc = FALSE,
						nSamples = 9, nTest = 11, nTestOE = 9,
						verbose = FALSE, compare_via_loo = TRUE,
						show_diagnostic_plots = FALSE, use_hierarchical_model = FALSE,
						use_prior_predictive = FALSE, train_on_OE = FALSE,
						use_binary_producers = TRUE,
						parametersToPlot = c('a','b','nu','phi','sigma'),
						is_nu_uniform = TRUE, no_decay_model = TRUE)
loo::compare(res_simple[[2]],res_block[[2]])
loo::compare(res_simple[[2]],res_prod[[2]])
loo::compare(res_block[[2]],res_prod[[2]])
loo::compare(res_simple[[2]],res_block[[2]],res_prod[[2]],res_prod4a[[2]])
```

```{r}

get_sum_of_log_lik <- function(estimates,id){
  log_lik_1 <- extract_log_lik(estimates)
  ll_df <- data.frame(ll=apply(log_lik_1,1,sum), id=id)
return(ll_df)
}

all_ll_df <- get_sum_of_log_lik(res_simple[[3]],id='simple') %>%
  full_join(get_sum_of_log_lik(res_block[[3]],id='block')) %>%
  full_join(get_sum_of_log_lik(res_prod[[3]],id='prod_2a')) %>%
  full_join(get_sum_of_log_lik(res_prod4a[[3]],id='prod_4a'))

library(ggridges)
ggplot(data=all_ll_df, aes(x=ll,y=id)) + 
  stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025,0.5, 0.975), alpha = 0.7) +
  theme_bw() + 
  labs(x='Log likelihood',y='Model')
  

```


