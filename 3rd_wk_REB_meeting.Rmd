---
title: "3rd wk REB meeting"
author: "Jonathan Harrison"
date: "25 October 2018"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=4,
                      echo=FALSE, warning=FALSE, message=FALSE)
```

##Data driven production models

Wanted a data driven production model. Collected data on nascent transcription.
Need to define:
1. distribution of production across cells
2. relative OE producton vs WT production

###Model M10
Take raw measurements of integrated fluorescence of nascent transcripts. 
Use these as estimates of production in each cell for each egg chamber, $\hat{a}_{ij}$.
```{r}
nTestOE=9
source('get_adjusted_producers.R')
get_adjusted_producers(nTestOE,T)
```

Problem with this: since the data come from fixed samples, the nascent transcripts only give us a single snapshot in time.
The number of nascent transcripts gives an instantaneous snapshot of the transcription rate but for the model, production rate $a$, relates to a longer time scale average production.
Instead we can attempt to model the fact that what we have observed is a random draw from a stochastic transcription process.
In particular, the observed measurements contain quite a few zeros where no nascent transcripts above the cosen threshold were detected in a given cell. 

##Model M11
Zero inflated poisson observation model for the transcription process.
$$
p(y | \theta, \lambda) =
\begin{cases}
\theta + (1-\theta) \, \text{Poisson}(0|\lambda) \hspace{3mm} \text{if } y=0, \\
(1-\theta) \, \text{Poisson}(y|\lambda) \hspace{3mm} \text{if } y > 0
\end{cases}
$$
We assume that there is some characteristic distribution of production across cells and all the egg chambers are noisy observations of this.
This model could be fitted directly to the observations of nascent transcription to give estimates for the transcription in each cell, as follows.

```{r}
source('estimate_adjusted_producers.R')
producers = estimate_adjusted_producers(nTestOE)

library(ggplot2)
library(dplyr)
library(tidyr)
source('extract_times_and_scaling.R')
times=extract_times_and_scaling(1,1,nTestOE)
df <- data_frame(transcription=list(producers[1,]),cellID=list(seq(16))) %>%
  unnest()

df %>% ggplot(aes(x=cellID,y=transcription)) + geom_line()
```

##Mode M12
Try also multiplying by 4 compared to WT production, rather than by 2.

##Compare production models
```{r}
source('forward_simulate.R')
```



##Summary
It is hard to estimate inhomogeneous production rates from fixed biological data, even with direct observations since we only have a single time point for each biological sample.


##Next Up
Look at influence of individual egg chambers via LOO.
```{r}

source('forward_simulate.R')

```

Seems that M13 (uniform production across cells of 4a) has least bad pareto k shape parameters. But still bad, meaning results are still highly influenced by indicidual data points. In particular the late time points. 
And early time point for the 4a production models.

Now repeat for $n=14$ and the influence of each cell rather than egg chamber. Then consider blocking and density dependence. 


Interesting that for almost all models, the oocyte comes out as being modelled badly, which I had not picked up. 
For some models, the cells far from the oocyte, also have large pareto k values.
For the data driven production models, it is largely cell 9 and the oocyte that are a problem.

Plot some of this visually.
```{r}

full_log_lik_by_cell %>%
  filter(modelID != 'M10') %>%
  filter(cellID == 1) %>%
  ggplot(aes(x=modelID,y=ll)) +
  geom_violin() + 
  facet_wrap(~cellID,scale='fixed')

# observed_and_predictions %>% filter(cellID==1) %>%
#     ggplot(aes(x=time,y=y_median,ymin=y_lower,ymax=y_upper)) +
#     geom_ribbon(alpha=0.4) +
#     geom_line() +
#     geom_point(aes(x=time,y=rna)) +
#     facet_wrap(~factor(modelID))  

```


##Blocking
In the blocking stan file, need to implement an equivalent forward simulate function, and expose this for use. 
Can then implement via forward simulation, with different production models.

##Density dependence
Similarly, but will also need to load different parameter estimates. 


