---
title: "Evaluating RNA localization model"
output:
  pdf_document: default
  html_document:
    df_print: paged
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=4,
                      echo=FALSE, warning=FALSE, message=FALSE)
```

Ideas discussed at last meeting:

1. Fit steady state model on different cells to evaluate whether $\nu$, the transport bias parameter, is spatially varying across the tissue.
2. Aggregate into two boxes, 1 and 2. 
3. Try forward simulating with different $\nu$. 

## Does $\nu$ vary spatially across the tissue?
First look at fitting models for different numbers of cells.
We consider the following combinations of cells:
1. Only oocyte and nurse cell 2 (1,2)
2. Oocyte and neighbouring nurse cells (1,2,3,5,9)
3. Oocyte and nurse cells within two steps from the oocyte (1,2,3,4,5,7,8,9,10,11,13)
4. All the nurse cells in the tissue (1:16)
5. Just with the cells further away from the oocyte (6,12,14,15,16) 
6. Everything except the oocyte and neighbouring nurse cells (4,6,7,8,10,11,12,13,14,15,16))

Now see if we can summarise the distribution of values for $\nu$ that we get for fitting to each different choice of cells
```{r}
library(dplyr)
library(ggplot2)
stst_df = data.frame(nu=numeric(),xi=numeric(),phi=numeric(),which_cells=integer())
for (id in seq(from=3,to=8)){
  load(paste('fits/alt_save_MCStstv20',id,'.Rsave',sep='')) #load in the results of fitting at stst for each choice of cells
  e$which_cells = rep(id-2,length(e$nu))
  stst_df = full_join(stst_df,as.data.frame(e))  
}
stst_df = stst_df %>% mutate(which_cells=factor(which_cells))
h <- ggplot(data = stst_df,aes(x=nu,color=which_cells)) + geom_density() + theme_bw()
h
```

This could certainly be interpreted as evidence of non-uniform bias in transport through ring canals spatially across the tissue.


----------------------------------------------------------------------------
## Two super-compartments

To reduce stochastic variation due to small sample sizes, we further consider agreggating into two super-compartments.
I assume well mixed concentrations of mRNA in each super-compartment.
If $\mathbf{y}$ is the vector of RNA concentrations in the oocyte and nurse cells, let $x_1$ be the sum over cells in the LHS of the tissue, and $x_2$ be the sum over cells in the RHS. By summing the original ODEs over the appropriate cell indices, we get:
\begin{eqnarray}
\frac{\text{d}x_1}{\text{d}t} &= 7a - b*(1-\nu)x_1 + b\nu x_2, \\
\frac{\text{d}x_2}{\text{d}t} &= 8a - b\nu x_2 + b(1-\nu) x_1.
\end{eqnarray}

From behaviour in the long time limit, (assuming $\nu \neq 0$) we get $$ x_2 = \frac{8a + b(1-\nu) x_1}{b\nu}. $$

```{r}
library(rstan)
library(mvtnorm)
library(dplyr)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
#read in data on WT
N=6 # sample size
data = matrix(as.numeric(read.csv('data/exp_data.csv',sep=',',header=FALSE,stringsAsFactors = FALSE)),ncol=16,byrow=TRUE)
data = data[seq_len(N),]
#aggregate into two compartments
x1_obs = data[,seq(from=1,to=16,by=2)] %>% apply(.,1,sum)
x2_obs = data[,seq(from=2,to=16,by=2)] %>% apply(.,1,sum)

  estimates <- stan(file = 'super_compartment_model.stan',
                    data = list (
                      N = N,
                      x1_obs = x1_obs,
                      x2_obs = x2_obs
                      ),
                    seed = 42,
                    chains = 4,
                    warmup = 1000,
                    iter = 2000,
                    control = list(adapt_delta = 0.99)
  )
print(estimates, pars = c('a','b','nu','sigma'))
pairs(estimates, pars = c('a','b','nu','sigma'))
```

The results from the two super-compartment model contradict what we have found using the full data suggesting that transport through ring canals should be less biased than previously thought, with median of $\nu=0.71$. However, these results rely upon an assumption of well mixed concentrations of mRNA within each super-compartment. This assumption does not hold. I would suggest that the results here may be misleading due to the inaccuracy of this assumption. 


----------------------------------
## Forward simulating with spatially varying $\nu$
We try forward simulating with different models, but particularly with different $\nu$ for the connections from neighbouring nurse cells to the oocyte. 

Now try to visualise the effect of changing $\nu$ by forward simulating from the model. (For this we will assume bidirectional transport through all ring canals again). We show the observed data as points, but the simulations use fixed values of the parameters and have not been fitted to these data. 

```{r}
library(rstan)
library(tidyr)
mc <- stan_model('model_comparison5.stan')
expose_stan_functions(mc) #get hold of functions defined in the stan code
#keep all other parameters constant during this experiment
m0 = c(0, rep(1,15)) #initial condition
th = c(4,300) #c(96.5,249)
sig = 50
phi = 0.289
nSamples = 15
nTest = 5
nTotal = nSamples + nTest
source('extract_times_and_scaling.R')
times = extract_times_and_scaling(nSamples,nTest,test_on_mutant_data=FALSE)
data = matrix(as.numeric(read.csv('data/exp_data.csv',sep=',',header=FALSE,stringsAsFactors = FALSE)),ncol=16,byrow=TRUE)
raw_data = data[times$sort_indices2,]
#take a vector of transport bias values for nu to loop through
nu_vec = seq(from=0.7, to=1, by=0.05)
all_extracted_samples = data.frame(rna=numeric(),time=numeric())
for (j in seq_along(nu_vec)){
B = construct_matrix(nu_vec[j])
samples <- stan(file = 'mrna_transport6.stan',
                  data = list (
                    T  = nTotal,
                    y0 = m0,
                    t0 = times$t0,
                    ts = times$ts2,
                    theta = array(th, dim = 2),
                    sigma = sig,
                    phi = phi,
                    B = B %>% as.vector()
                  ),
                  algorithm="Fixed_param",
                  seed = 42,
                  chains = 1,
                  iter =100, 
                  refresh = -1
  )
estimates = rstan::extract(samples, pars='y_hat')
#make the samples go in a 'nice' format
pred <- as.data.frame(estimates, pars = 'y_hat') %>%
  gather(factor_key = TRUE) %>%
  group_by(key) %>%
  summarize(lb = quantile(value, probs = 0.05),
            median = quantile(value, probs = 0.5),
            ub = quantile(value, probs = 0.95))
xdata <- data.frame(rna = as.vector(raw_data),cellID = as.vector(matrix(rep(1:16,nTotal),nrow=nTotal,byrow=TRUE)),time = rep(times$ts2,16))
pred <- pred %>% bind_cols(xdata) %>%
        mutate(split = if_else(time %in% times$ts3,'train','test'),
               nu = nu_vec[j])
all_extracted_samples = full_join(all_extracted_samples, pred)
}

p1 <- ggplot(all_extracted_samples, aes(x = time, y = median, group = factor(nu), color=factor(nu)))
p1 <- p1 + geom_line() +
  facet_wrap(~cellID,scales='free') +   #needed to remove factor(cellID) 
  labs(x = "time", y = "rna") +
  theme(text = element_text(size = 12), axis.text = element_text(size = 12),
        strip.text = element_text(size = 8)) + 
  scale_color_discrete(name = "nu") + 
  scale_colour_brewer(palette=7) + 
  geom_point(aes(x = time, y = rna))
p1

```

And finally compare this to what happens when we change one the transport bias for ring canals to the oocyte, with bias $\nu$ for the other ring canals fixed at $0.71$. 

```{r}
B1 = construct_matrix(0.71) #we fix ring canals for all other nurse cells
#take a vector of transport bias values for nu to loop through
nu_vec = seq(from=0.7, to=1, by=0.05)
all_extracted_samples = data.frame(rna=numeric(),time=numeric())
for (j in seq_along(nu_vec)){
#mess around with ring canals into oocyte 
  B2 = construct_matrix(nu_vec[j])
  B = B1
  B[,1] = B2[,1]
  B[1,] = B2[1,]
  diag(B) = diag(B) - apply(B,2,sum)
samples <- stan(file = 'mrna_transport6.stan',
                  data = list (
                    T  = nTotal,
                    y0 = m0,
                    t0 = times$t0,
                    ts = times$ts2,
                    theta = array(th, dim = 2),
                    sigma = sig,
                    phi = phi,
                    B = B %>% as.vector()
                  ),
                  algorithm="Fixed_param",
                  seed = 42,
                  chains = 1,
                  iter =100, 
                  refresh = -1
  )
estimates = rstan::extract(samples, pars='y_hat')
#make the samples go in a 'nice' format
pred <- as.data.frame(estimates, pars = 'y_hat') %>%
  gather(factor_key = TRUE) %>%
  group_by(key) %>%
  summarize(lb = quantile(value, probs = 0.05),
            median = quantile(value, probs = 0.5),
            ub = quantile(value, probs = 0.95))
xdata <- data.frame(rna = as.vector(raw_data),cellID = as.vector(matrix(rep(1:16,nTotal),nrow=nTotal,byrow=TRUE)),time = rep(times$ts2,16))
pred <- pred %>% bind_cols(xdata) %>%
        mutate(split = if_else(time %in% times$ts3,'train','test'),
               nu = nu_vec[j])
all_extracted_samples = full_join(all_extracted_samples, pred)
}

p2 <- ggplot(all_extracted_samples, aes(x = time, y = median, group = factor(nu), color=factor(nu)))
p2 <- p2 + geom_line() +
  facet_wrap(~cellID,scales='free') +   #needed to remove factor(cellID) 
  labs(x = "time", y = "rna") +
  theme(text = element_text(size = 12), axis.text = element_text(size = 12),
        strip.text = element_text(size = 8)) + 
  scale_color_discrete(name = "nu") + 
  scale_colour_brewer(palette=7) + 
  geom_point(aes(x = time, y = rna))
p2

```

Changing the transport bias, $\nu$, for selected ring canals neighbouring the oocyte has limited effect relative to predictions from the simpler model where $\nu$ is assumed to be spatially uniform. 

--------------------------
## Fitting model with spatially varying $\nu$

Consider fitting this model with spatially varying $\nu$ values based on whether cells are neighbouring the oocyte. All that is different here to the full model considered previously is the construction of the matrix $B$. 

```{r}
source('mrna_transport_full.R')
a <- mrna_transport_inference_full('full_spatial_nu_v201', use_real_data = TRUE, run_mcmc = FALSE, nSamples=6, nTest=14, show_diagnostic_plots = TRUE, parametersToPlot = c("a","b","phi","sigma","gamma","nu1","nu2"), test_on_mutant_data = FALSE)

```

Interpretation of results: by eye, the posterior predictive distribution seems to match better with observed data across all the cells, whereas with other simpler models a good fit could be obtained for some but not all the nurse cells. The bias in ring canals further from the oocyte is much lower (median around 0.25) than in the cells close to the oocyte (median around 0.92). The model used here is the full ODE system in time and includes RNA decay at rate $\gamma$. Estimates of $\gamma$ had previously been very close to 0 and model comparison suggested that decay was not important in the model. However, here estimates of the decay rate are higher (median around 0.8). This is very similar to the prior for $\gamma$ and it should be investigated what the influence of the prior for the decay rate is here.

Finally, we should make predictions for the full model for Wild Type and Overexpression mutant, with spatially uniform $\nu$ and spatially varying $\nu$ and perform model comparison between the two models to assess whether this hypothesis that $\nu$ varies spatially is plausible and whether there is evidence for this compared to spatially uniform $\nu$.

-----------------------------------------------
## Comparing the spatially varying $\nu$ and spatially uniform $\nu$ models
We use leave one out model comparison to evaluate whether the model with spatially varying bias $\nu$ is an improvement over the simpler model with uniform $\nu$. 

```{r}
source('mrna_transport_full.R')
res_uniform = mrna_transport_inference_full('full_nu_uniform_v234',use_real_data = TRUE, run_mcmc = TRUE, nSamples = 8, nTest = 12, nTestOE = 7, verbose = FALSE, compare_via_loo = TRUE, show_diagnostic_plots = TRUE, test_on_mutant_data = FALSE, is_nu_uniform = TRUE)

res_varying = mrna_transport_inference_full('full_nu_uniform_v235',use_real_data = TRUE, run_mcmc = TRUE, nSamples = 8, nTest = 12, nTestOE = 7, verbose = FALSE, compare_via_loo = TRUE, show_diagnostic_plots = TRUE, test_on_mutant_data = FALSE, is_nu_uniform = FALSE)

print(loo::compare(res_uniform[[2]],res_varying[[2]]))
```

The difference between these is positive and larger than twice the standard error which confirms that the spatially varying $\nu$ model is more predictive that the simpler uniform $\nu$ model. This suggests that the model with spatially varying bias in transport through ring canals is an improved model. 

TODO: Next we will consider the predictive abilities of such a model on overexpression data.


-----------------------------------------------

## Assuming the oocyte is an absorbing state
Another possibility: assume the oocyte is an absorbing state. Currently we assume bidirectional transport through each ring canal. We could hypothesize that the connections directly to the oocyte are `special' in some way such that transport only occurs in one direction here. This should decrease the concentration of mRNA in the neighbouring nurse cells and increase in the oocyte in the model.

But at steady state, the absorbing oocyte case results in *qualitatively* different behaviour in the sense that for this case the eigenvector corresponding to the largest eigenvalue is [1,0 ... 0] irrespective of the transport bias $\nu$. 
mRNA accumulates in the oocyte but not in the nurse cells, whereas assuming all the ring canals are bidirectional results in a distribution of mRNA across cells dependent on $\nu$ with nonzero values in the nurse cells.


```{r}
nu = 0.72 #pick a vlaue for the bias from ring canals
B = construct_matrix(0.72)
set_oocyte_absorbing = function(B){
  B[,1] = 0
  return(B)
}
B = construct_matrix(nu)
B_absorb = set_oocyte_absorbing(B)

print(eigen(B))
print(eigen(B_absorb))
```
